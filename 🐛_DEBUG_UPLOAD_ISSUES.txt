═══════════════════════════════════════
🐛 DEBUG: File Upload Issues
═══════════════════════════════════════

Status: Error logging added
Date: 2025-10-08

═══════════════════════════════════════
✅ WHAT I FIXED
═══════════════════════════════════════

1. ✅ Added error handling to upload middleware
2. ✅ Added detailed logging to upload route
3. ✅ Improved error messages
4. ✅ Better destination path handling

═══════════════════════════════════════
🔍 HOW TO DEBUG THE UPLOAD ERROR
═══════════════════════════════════════

Step 1: Start the app
--------------------
npm run dev

Step 2: Open browser
-------------------
Go to: http://localhost:5173

Step 3: Open DevTools
---------------------
Press F12 to open browser console

Step 4: Try uploading
--------------------
1. Click "Create Session"
2. Select files to upload
3. Click "Upload Files"
4. Watch BOTH:
   - Browser console (F12)
   - Terminal where backend is running

═══════════════════════════════════════
📋 WHAT TO CHECK
═══════════════════════════════════════

In Browser Console (F12 → Console):
-----------------------------------
Look for errors like:
❌ Failed to fetch
❌ Network error
❌ 404 Not Found
❌ 500 Internal Server Error

In Backend Terminal:
-------------------
Look for these messages:
[UPLOAD] Attempting to upload files for session: xxxxxx
[UPLOAD] Session found. Files received: X
[UPLOAD] Adding files to session...
[UPLOAD] Success! X files uploaded

Or error messages:
❌ [UPLOAD] Session not found
❌ [UPLOAD] No files in request
❌ [UPLOAD] Error uploading files: ...
❌ Error setting upload destination
❌ Error generating filename

═══════════════════════════════════════
🔧 COMMON ISSUES & FIXES
═══════════════════════════════════════

Issue 1: "Session not found"
---------------------------
Problem: Session creation failed or expired
Fix: 
  1. Check if "Create Session" button works
  2. Verify session code appears
  3. Try uploading immediately after creating

Issue 2: "No files in request"
-----------------------------
Problem: Files not being sent from frontend
Fix:
  1. Check file size (max 20MB per file)
  2. Check file type (JPEG, PNG, WebP only)
  3. Check browser console for errors

Issue 3: "ENOENT" or "Permission denied"
---------------------------------------
Problem: Storage directory issues
Fix:
  1. Check if storage/ folder exists
  2. Run as administrator if needed
  3. Check folder permissions

Issue 4: Backend not running
---------------------------
Problem: npm run dev didn't start properly
Fix:
  1. Kill any existing node processes
  2. Run: npm run dev
  3. Wait for "Server running" message

═══════════════════════════════════════
🧪 MANUAL TEST STEPS
═══════════════════════════════════════

1. Start the app:
   npm run dev

2. Wait for both to start:
   ✓ Backend: http://localhost:3000
   ✓ Frontend: http://localhost:5173

3. Test backend directly:
   Open: http://localhost:3000/api/health
   Should see: {"status":"ok","timestamp":"..."}

4. Test session creation:
   Open browser console (F12)
   Go to: http://localhost:5173
   Click: "Create Session"
   Should see: 6-character code

5. Test file upload:
   - Select a small image (< 5MB)
   - Must be JPEG, PNG, or WebP
   - Click "Upload Files"
   - Watch backend terminal for logs

═══════════════════════════════════════
📝 ERROR MESSAGES EXPLAINED
═══════════════════════════════════════

"Failed to upload files"
→ Generic error from frontend
→ Check backend terminal for real error

"Session not found or expired"
→ Session code is invalid or old
→ Create a new session

"No files uploaded"
→ Files not received by backend
→ Check file size and type

"File too large"
→ File exceeds 20MB limit
→ Use smaller files

"Only JPEG, PNG, and WebP images are allowed"
→ Wrong file type
→ Use image files only

═══════════════════════════════════════
🚀 QUICK FIX COMMANDS
═══════════════════════════════════════

Kill all Node processes:
Get-Process -Name node | Stop-Process -Force

Check if port 3000 is in use:
Get-NetTCPConnection -LocalPort 3000 -ErrorAction SilentlyContinue

Check storage folder:
Test-Path "storage"
Get-ChildItem "storage"

Delete storage and recreate:
Remove-Item "storage" -Recurse -Force
New-Item -ItemType Directory -Path "storage"

═══════════════════════════════════════
📊 EXPECTED LOG OUTPUT (Good)
═══════════════════════════════════════

Backend Terminal:
[UPLOAD] Attempting to upload files for session: abc123
[UPLOAD] Session found. Files received: 1
[UPLOAD] Adding files to session...
[UPLOAD] Success! 1 files uploaded

Browser Console:
POST /api/sessions/abc123/files 200 OK
Response: {message: "Files uploaded successfully", ...}

═══════════════════════════════════════
❌ EXAMPLE ERROR LOGS (Bad)
═══════════════════════════════════════

Backend Terminal:
[UPLOAD] Error uploading files: Error: ENOENT: no such file or directory
→ Storage folder issue

[UPLOAD] Session not found: abc123
→ Session expired or invalid

Browser Console:
POST /api/sessions/abc123/files 404 Not Found
→ Session doesn't exist

POST /api/sessions/abc123/files net::ERR_CONNECTION_REFUSED
→ Backend not running

═══════════════════════════════════════
📞 NEXT STEPS IF STILL FAILING
═══════════════════════════════════════

1. Copy the EXACT error message from:
   - Browser console (F12)
   - Backend terminal

2. Check these files exist:
   □ api/routes/sessions.js
   □ api/middleware/upload.js
   □ api/utils/storage.js
   □ storage/ folder

3. Try uploading a very small image (< 1MB)

4. Try with a different browser

5. Restart the entire app:
   - Close all terminals
   - Run: npm run dev
   - Try again

═══════════════════════════════════════
✅ STATUS
═══════════════════════════════════════

✓ Error logging added
✓ Upload middleware improved
✓ Debugging enabled
✓ Ready for testing

App should be running now!
Check terminal for errors.
